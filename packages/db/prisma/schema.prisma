generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String    @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?   // Optional for OAuth users
  role           String    @default("user") // "admin" or "user"
  phone          String?   // Added for profile management
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt @default(now())

  accounts       Account[]
  sessions       Session[]
  bookings       Booking[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model City {
  id        String  @id @default(cuid())
  name      String
  state     String
  active    Boolean @default(true)
  isAirport Boolean @default(false)

  bookingsFrom Booking[] @relation("FromCity")
  bookingsTo   Booking[] @relation("ToCity")
  routesFrom   CityRoute[] @relation("FromCityRoute")
  routesTo     CityRoute[] @relation("ToCityRoute")

  @@index([name, state])
}

model CityRoute {
  id           String  @id @default(cuid())
  fromCityId   String
  toCityId     String
  distanceKm   Int
  durationMin  Int
  active       Boolean @default(true)
  tripTypes    String 

  fromCity City @relation("FromCityRoute", fields: [fromCityId], references: [id])
  toCity   City @relation("ToCityRoute", fields: [toCityId], references: [id])

  routePricing RoutePricing[]

  @@unique([fromCityId, toCityId])
}

model CabType {
  id       String  @id @default(cuid())
  name     String
  seats    Int
  luggage  Int
  image    String?
  active   Boolean @default(true)
  features String?

  pricingRules PricingRule[]
  routePricing RoutePricing[]
  bookings     Booking[]

  @@unique([name])
}

model PricingRule {
  id          String   @id @default(cuid())
  cabTypeId   String
  tripType    String 
  baseFare    Int
  perKm       Int
  perMinute   Int
  minKmPerDay Int      @default(0)
  surgeJson   String?
  validFrom   DateTime?
  validTo     DateTime?
  active      Boolean  @default(true)

  cabType CabType @relation(fields: [cabTypeId], references: [id])

  @@unique([cabTypeId, tripType])
}

model RoutePricing {
  id           String   @id @default(cuid())
  routeId      String
  fromCityId   String 
  toCityId     String 
  cabTypeId    String
  tripType     String 
  price        Int 
  active       Boolean  @default(true)
  validFrom    DateTime?
  validTo      DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  route   CityRoute @relation(fields: [routeId], references: [id])
  cabType CabType   @relation(fields: [cabTypeId], references: [id])

  @@unique([fromCityId, toCityId, cabTypeId, tripType])
  @@index([routeId])
  @@index([fromCityId, toCityId])
}

model Booking {
  id            String   @id @default(cuid())
  userId        String?  // Link to User model
  tripType      String 
  fromCityId    String? 
  toCityId      String? 
  startAt       DateTime
  endAt         DateTime?
  returnAt      DateTime?
  cabTypeId     String
  distanceKm    Int
  durationMin   Int
  priceQuote    Int
  customerName  String
  customerPhone String
  customerEmail String?
  pickupAddress String?
  dropAddress   String?
  status        String   @default("pending")
  paymentRef    String?
  createdAt     DateTime @default(now())

  user     User?   @relation(fields: [userId], references: [id])
  fromCity City?   @relation("FromCity", fields: [fromCityId], references: [id])
  toCity   City?   @relation("ToCity", fields: [toCityId], references: [id])
  cabType  CabType @relation(fields: [cabTypeId], references: [id])

  @@index([fromCityId, toCityId, startAt])
  @@index([cabTypeId])
  @@index([tripType])
  @@index([userId])
}

model Inquiry {
  id            String   @id @default(cuid())
  tripType      String
  fromLocation  String
  toLocation    String
  startDate     DateTime
  endDate       DateTime?
  customerName  String
  customerPhone String
  customerEmail String
  pickupAddress String?
  dropAddress   String?
  requirements  String?
  status        String   @default("pending")
  createdAt     DateTime @default(now())

  @@index([tripType, status])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  valueJson String
  updatedAt DateTime @updatedAt
}